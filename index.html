<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Caring Tap Game</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height:100%; margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#000; overflow:hidden; }
    #frame { width:100vw; height:100vh; position:relative; overflow:hidden; background:#120818; }
    #bgLayer { position:absolute; inset:0; z-index:0; background:linear-gradient(135deg,#1a0a2e 0%,#3d0a1a 50%,#0a1a2e 100%); background-position:center; background-size:cover; background-repeat:no-repeat; pointer-events:none; }
    #bgTint  { position:absolute; inset:0; z-index:1; background:rgba(10,0,8,0.35); pointer-events:none; }
    #c { position:absolute; inset:0; z-index:2; width:100%; height:100%; display:block; pointer-events:none; }
    #c.active { pointer-events:auto; }
    .hud {
      position:absolute;
      /* Rotated 90¬∞ clockwise ‚Äî sits on the RIGHT edge of screen */
      right: -38vh; top: 50%;
      width: 100vh;
      transform: translateY(-50%) rotate(90deg);
      transform-origin: center center;
      display:flex; justify-content:space-between;
      gap:16px; z-index:3; pointer-events:none;
      padding: 0 20px;
    }
    .pill { padding:14px 20px; border-radius:16px; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.22); color:#fff; font-weight:900; font-size:32px; backdrop-filter:blur(6px); white-space:nowrap; }
    #overlay { position:fixed; inset:0; z-index:999999; display:grid; place-items:start center; background:radial-gradient(1200px 800px at 50% 30%,rgba(255,255,255,.07),rgba(0,0,0,.65)); color:#fff; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:20px 0; }
    #overlay.hidden { display:none; }
    .card { width:min(860px,94%); margin:0 auto; border-radius:18px; border:1px solid rgba(255,255,255,.14); background:rgba(20,10,18,.95); padding:20px; box-shadow:0 16px 40px rgba(0,0,0,.6); text-align:center; }
    .card h1 { margin:6px 0; font-size:20px; }
    .card p  { margin:6px 0; opacity:.92; font-size:13px; line-height:1.4; }
    .btn { display:block; width:100%; margin-top:12px; padding:13px 14px; border-radius:14px; border:none; cursor:pointer; font-weight:900; font-size:15px; background:linear-gradient(180deg,#ffcf4a,#ff9f2e); color:#2a1500; box-shadow:0 8px 20px rgba(0,0,0,.4); -webkit-tap-highlight-color:transparent; }
    .btn:active { transform:scale(.98); opacity:.9; }
    .btn.grey { background:linear-gradient(180deg,#eee,#ccc); color:#111; }
    .settingRow { margin-top:10px; text-align:left; background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:14px; }
    .rowLabel { display:flex; justify-content:space-between; align-items:center; font-weight:800; font-size:13px; margin-bottom:8px; }
    input[type="range"] { width:100%; cursor:pointer; }
    input[type="file"]  { width:100%; max-width:100%; cursor:pointer; }
    input[type="number"] { width:58px; padding:4px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.4); color:#fff; font-weight:800; font-size:13px; text-align:center; }
    .assetGrid { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; }
    .assetCol  { flex:1 1 155px; min-width:150px; }
    .assetPreviewRow { margin-top:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .assetNote { font-size:11px; opacity:.85; line-height:1.3; }
    .pointRow { display:flex; align-items:center; gap:6px; margin-top:7px; font-size:12px; font-weight:700; }
    .pointRow span { opacity:.8; }
    #drumStatus { margin-top:8px; font-size:12px; font-weight:700; color:#7dffb3; text-align:center; padding:8px 10px; background:rgba(0,0,0,.3); border-radius:10px; }
    .sectionTitle { font-weight:900; font-size:13px; margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,.12); }
    .hint { margin-top:10px; font-size:12px; opacity:.75; text-align:center; }
    .gpRow { display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; margin-top:8px; }
    .gpRow label { display:flex; align-items:center; gap:4px; font-weight:700; }
  </style>
</head>
<body>
<div id="frame">
  <div id="bgLayer"><img id="bgImg" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;" /></div>
  <div id="bgTint"></div>
  <div class="hud">
    <div class="pill">Score: <span id="score">0</span></div>
    <div class="pill">Time: <span id="time">30</span>s</div>
  </div>
  <canvas id="c"></canvas>

  <div id="overlay">
    <div class="card">
      <h1 id="title">üßß Caring Tap Game</h1>
      <p id="desc">Drum on the <b>LEFT</b>, notes come from the <b>RIGHT</b>.<br/>Hit logos = points earned. Hit BOOM = penalty.</p>

      <!-- SPEED -->
      <div class="settingRow">
        <div class="rowLabel">Speed (Hardness) <span id="speedLabel">1.0x</span></div>
        <input id="speed" type="range" min="0.7" max="6.0" step="0.1" value="1.0" />
        <p style="margin:5px 0 0;font-size:12px;opacity:.8;">Higher = faster notes &amp; beats.</p>
      </div>

      <!-- DRUM CONTROLLER -->
      <div class="settingRow">
        <div class="sectionTitle">ü•Å Drum Controller</div>
        <div id="drumStatus">Waiting‚Ä¶ plug in drum and press a pad.</div>
        <p style="margin:8px 0 4px;font-size:12px;opacity:.85;">
          Supports any USB/Bluetooth gamepad (Taiko controller, etc).<br/>
          Keyboard <b>F</b> or <b>J</b> also works as fallback. Tapping the drum on screen works too.
        </p>
        <div style="margin-top:10px;">
          <div style="font-weight:800;font-size:12px;margin-bottom:6px;">üîç Button Tester ‚Äî press your drum pads now:</div>
          <div id="btnTester" style="font-family:monospace;font-size:12px;background:rgba(0,0,0,.4);border-radius:8px;padding:8px;min-height:36px;color:#7dffb3;">Hit any pad to see button numbers‚Ä¶</div>
          <div style="margin-top:8px;font-weight:800;font-size:12px;margin-bottom:4px;">Map buttons to hit action (enter numbers from tester above):</div>
          <div class="gpRow">
            <label>Don L: <input type="number" id="btnDonL" value="0" min="0" max="63"></label>
            <label>Don R: <input type="number" id="btnDonR" value="1" min="0" max="63"></label>
            <label>Ka L:  <input type="number" id="btnKaL"  value="2" min="0" max="63"></label>
            <label>Ka R:  <input type="number" id="btnKaR"  value="3" min="0" max="63"></label>
          </div>
          <p style="margin:5px 0 0;font-size:11px;opacity:.7;">Set all 4 to the same number if your drum only has one zone.</p>
        </div>
      </div>

      <!-- AUDIO -->
      <div class="settingRow">
        <div class="sectionTitle">üîä Audio Settings</div>
        <div style="display:grid;gap:12px;">
          <div>
            <div class="rowLabel">Drum FX Volume <span id="drumVolLabel">80%</span></div>
            <input id="drumVol" type="range" min="0" max="1" step="0.01" value="0.80" />
          </div>
          <div>
            <div class="rowLabel">Background Music Volume <span id="musicVolLabel">35%</span></div>
            <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.35" />
          </div>
          <div>
            <div style="font-weight:800;font-size:12px;margin-bottom:5px;">Upload Background Music (loop)</div>
            <input id="musicFile" type="file" accept="audio/*" />
            <div id="musicStatus" style="margin-top:5px;font-size:11px;color:#7dffb3;min-height:16px;"></div>
            <button class="btn grey" id="resetMusic" style="margin-top:6px;">Reset Music</button>
          </div>
          <div>
            <div style="font-weight:800;font-size:12px;margin-bottom:5px;">Upload Drum Hit SFX</div>
            <input id="drumFile" type="file" accept="audio/*" />
            <div id="drumSfxStatus" style="margin-top:5px;font-size:11px;color:#7dffb3;min-height:16px;"></div>
            <button class="btn grey" id="resetDrum" style="margin-top:6px;">Reset Drum SFX</button>
          </div>
        </div>
      </div>

      <!-- ASSETS + POINTS -->
      <div class="settingRow">
        <div class="sectionTitle">üñºÔ∏è Images &amp; Points per Hit</div>
        <div class="assetGrid">

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">Logo 1 (main)</div>
            <input id="logoFile" type="file" accept="image/*" />
            <div class="assetPreviewRow">
              <canvas id="logoPrev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">Circle crop</div>
            </div>
            <div class="pointRow"><span>Hit:</span><input type="number" id="logo1pts" value="1" min="-99" max="99"><span>pts</span></div>
          </div>

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">Logo 2</div>
            <input id="logo2File" type="file" accept="image/*" />
            <div class="assetPreviewRow">
              <canvas id="logo2Prev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">Optional</div>
            </div>
            <div class="pointRow"><span>Hit:</span><input type="number" id="logo2pts" value="2" min="-99" max="99"><span>pts</span></div>
          </div>

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">Logo 3</div>
            <input id="logo3File" type="file" accept="image/*" />
            <div class="assetPreviewRow">
              <canvas id="logo3Prev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">Optional</div>
            </div>
            <div class="pointRow"><span>Hit:</span><input type="number" id="logo3pts" value="3" min="-99" max="99"><span>pts</span></div>
          </div>

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">BOOM (penalty)</div>
            <input id="boomFile" type="file" accept="image/*" />
            <div class="assetPreviewRow">
              <canvas id="boomPrev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">Default star</div>
            </div>
            <div class="pointRow"><span>Hit:</span><input type="number" id="boompts" value="-5" min="-99" max="99"><span>pts</span></div>
          </div>

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">DRUM image</div>
            <input id="hitFile" type="file" accept="image/*" />
            <div class="assetPreviewRow">
              <canvas id="hitPrev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">On drum</div>
            </div>
          </div>

          <div class="assetCol">
            <div style="font-weight:800;font-size:11px;margin-bottom:4px;">Background</div>
            <input id="bgFile" type="file" accept="image/*" />
            <div id="bgStatus" style="font-size:11px;color:#7dffb3;margin-top:4px;min-height:14px;"></div>
            <div class="assetPreviewRow">
              <canvas id="bgPrev" width="66" height="66" style="border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);"></canvas>
              <div class="assetNote">GIF ‚úÖ</div>
            </div>
          </div>

        </div>
        <button class="btn grey" id="resetAssets" style="margin-top:12px;">Reset All Assets</button>
        <p style="margin:7px 0 0;font-size:11px;opacity:.7;">All uploads saved in browser localStorage.</p>
      </div>

      <button class="btn" id="startBtn" style="font-size:17px;padding:15px;margin-top:16px;">‚ñ∂ START</button>
      <div class="hint">Keyboard: <b>F</b> or <b>J</b> to hit &nbsp;|&nbsp; ESC = exit fullscreen</div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  const DEFAULT_LOGO_URL     = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23e74c3c' stroke='%23fff' stroke-width='4'/%3E%3Ctext x='50' y='58' font-size='36' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle'%3E‚ô•%3C/text%3E%3C/svg%3E";
  const DEFAULT_BG_URL       = ""; // no external default ‚Äî uses CSS gradient fallback
  const DEFAULT_HIT_ICON_URL = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cellipse cx='50' cy='35' rx='40' ry='15' fill='%23c0392b' stroke='%23fff' stroke-width='3'/%3E%3Crect x='10' y='35' width='80' height='40' fill='%23e74c3c'/%3E%3Cellipse cx='50' cy='75' rx='40' ry='15' fill='%23c0392b' stroke='%23fff' stroke-width='3'/%3E%3Cellipse cx='50' cy='35' rx='40' ry='15' fill='%23e74c3c' stroke='%23fff' stroke-width='3'/%3E%3C/svg%3E";

  const frame    = document.getElementById("frame");
  const bgLayer  = document.getElementById("bgLayer");
  const bgTint   = document.getElementById("bgTint");
  const canvas   = document.getElementById("c");
  const ctx      = canvas.getContext("2d");
  const scoreEl  = document.getElementById("score");
  const timeEl   = document.getElementById("time");
  const overlay  = document.getElementById("overlay");
  const titleEl  = document.getElementById("title");
  const descEl   = document.getElementById("desc");
  const startBtn = document.getElementById("startBtn");
  const drumStatusEl = document.getElementById("drumStatus");

  function showMenu() { overlay.classList.remove("hidden"); canvas.classList.remove("active"); }
  function hideMenu() { overlay.classList.add("hidden");   canvas.classList.add("active"); }
  showMenu();

  async function goFullscreen() {
    try { if (!document.fullscreenElement && frame.requestFullscreen) await frame.requestFullscreen(); } catch(e){}
  }

  function resize() {
    const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
    canvas.width =Math.floor(window.innerWidth *dpr);
    canvas.height=Math.floor(window.innerHeight*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize",resize);
  document.addEventListener("fullscreenchange",resize);
  resize();

  // Speed
  const speedSlider=document.getElementById("speed");
  const speedLabel =document.getElementById("speedLabel");
  let speedMul=1.0;
  speedSlider.addEventListener("input",()=>{ speedMul=Number(speedSlider.value); speedLabel.textContent=speedMul.toFixed(1)+"x"; });

  // LS keys
  const LS={ LOGO1:"cg_logo1",LOGO2:"cg_logo2",LOGO3:"cg_logo3",BOOM:"cg_boom",HIT:"cg_hit",BG:"cg_bg",MUSIC:"cg_music",DRUM_SFX:"cg_drum_sfx",PTS:"cg_points" };

  function readFile(f){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f); }); }

  // Points
  let pts={ logo1:1, logo2:2, logo3:3, boom:-5 };
  try{ const s=localStorage.getItem(LS.PTS); if(s) pts=JSON.parse(s); }catch(e){}
  const ptsEl={ logo1:document.getElementById("logo1pts"), logo2:document.getElementById("logo2pts"), logo3:document.getElementById("logo3pts"), boom:document.getElementById("boompts") };
  ptsEl.logo1.value=pts.logo1; ptsEl.logo2.value=pts.logo2; ptsEl.logo3.value=pts.logo3; ptsEl.boom.value=pts.boom;
  function savePts(){ pts.logo1=parseInt(ptsEl.logo1.value)||0; pts.logo2=parseInt(ptsEl.logo2.value)||0; pts.logo3=parseInt(ptsEl.logo3.value)||0; pts.boom=parseInt(ptsEl.boom.value)||0; localStorage.setItem(LS.PTS,JSON.stringify(pts)); }
  Object.values(ptsEl).forEach(el=>el.addEventListener("change",savePts));

  // Images
  function makeImg(){ const i=new Image(); i.crossOrigin="anonymous"; return i; }
  const imgs={ logo1:makeImg(),logo2:makeImg(),logo3:makeImg(),boom:makeImg(),hit:makeImg() };
  const rdy={ logo1:false,logo2:false,logo3:false,boom:false,hit:false };

  function loadImg(key,src){ rdy[key]=false; imgs[key].onload=()=>{ rdy[key]=true; drawPreviews(); }; imgs[key].onerror=()=>{ rdy[key]=false; drawPreviews(); }; if(src) imgs[key].src=src; }
  loadImg("logo1",localStorage.getItem(LS.LOGO1)||DEFAULT_LOGO_URL);
  loadImg("logo2",localStorage.getItem(LS.LOGO2)||"");
  loadImg("logo3",localStorage.getItem(LS.LOGO3)||"");
  loadImg("boom", localStorage.getItem(LS.BOOM)||"");
  loadImg("hit",  localStorage.getItem(LS.HIT)||DEFAULT_HIT_ICON_URL);

  function setBg(src){
    const bgImg = document.getElementById("bgImg");
    if(src){
      // Use <img> tag ‚Äî works for GIF animation AND static images
      bgImg.src = src;
      bgImg.style.display = "block";
      bgLayer.style.backgroundImage = "none";
    } else {
      // No image ‚Äî show CSS gradient
      bgImg.style.display = "none";
      bgImg.src = "";
      bgLayer.style.backgroundImage = "none";
    }
  }
  setBg(localStorage.getItem(LS.BG)||DEFAULT_BG_URL);

  function bindFile(id,lsKey,imgKey){ document.getElementById(id).addEventListener("change",async e=>{ const f=e.target.files?.[0]; if(!f) return; const url=await readFile(f); localStorage.setItem(lsKey,url); if(imgKey) loadImg(imgKey,url); }); }
  bindFile("logoFile", LS.LOGO1,"logo1");
  bindFile("logo2File",LS.LOGO2,"logo2");
  bindFile("logo3File",LS.LOGO3,"logo3");
  bindFile("boomFile", LS.BOOM, "boom");
  bindFile("hitFile",  LS.HIT,  "hit");

  // BG file ‚Äî use object URL directly so GIF animation works
  let bgObjectUrl = null;
  const bgStatusEl = document.getElementById("bgStatus");

  // ‚îÄ‚îÄ IndexedDB for background (no size limit, works for large GIFs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const IDB_NAME = "caringGame", IDB_STORE = "assets", IDB_BG_KEY = "bg_blob";

  function openIDB(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE);
      req.onsuccess = e => res(e.target.result);
      req.onerror   = e => rej(e.target.error);
    });
  }
  function idbSet(key, val){
    return openIDB().then(db => new Promise((res,rej)=>{
      const tx = db.transaction(IDB_STORE,"readwrite");
      tx.objectStore(IDB_STORE).put(val, key);
      tx.oncomplete = res; tx.onerror = rej;
    }));
  }
  function idbGet(key){
    return openIDB().then(db => new Promise((res,rej)=>{
      const req = db.transaction(IDB_STORE,"readonly").objectStore(IDB_STORE).get(key);
      req.onsuccess = e => res(e.target.result);
      req.onerror   = e => rej(e.target.error);
    }));
  }
  function idbDel(key){
    return openIDB().then(db => new Promise((res,rej)=>{
      const tx = db.transaction(IDB_STORE,"readwrite");
      tx.objectStore(IDB_STORE).delete(key);
      tx.oncomplete = res; tx.onerror = rej;
    }));
  }

  function applyBgBlob(blob){
    if(bgObjectUrl) URL.revokeObjectURL(bgObjectUrl);
    bgObjectUrl = URL.createObjectURL(blob);
    setBg(bgObjectUrl);
  }

  function updateBgStatus(sizeBytes){
    if(sizeBytes > 0){
      bgStatusEl.textContent = "‚úÖ Saved (" + Math.round(sizeBytes/1024) + " KB) ‚Äî persists on refresh";
      bgStatusEl.style.color = "#7dffb3";
    } else {
      bgStatusEl.textContent = "‚¨ú No background saved";
      bgStatusEl.style.color = "rgba(255,255,255,0.45)";
    }
  }

  document.getElementById("bgFile").addEventListener("change", async e=>{
    const f = e.target.files?.[0]; if(!f) return;
    applyBgBlob(f); // show immediately
    bgStatusEl.textContent = "üíæ Saving‚Ä¶";
    bgStatusEl.style.color = "#ffd54a";
    try{
      await idbSet(IDB_BG_KEY, f); // save the raw File/Blob ‚Äî no size limit!
      updateBgStatus(f.size);
    } catch(err){
      bgStatusEl.textContent = "‚ùå Could not save: " + err.message;
      bgStatusEl.style.color = "#ff6b6b";
    }
  });

  // Restore on load from IndexedDB
  (async function restoreBg(){
    try{
      const blob = await idbGet(IDB_BG_KEY);
      if(blob){ applyBgBlob(blob); updateBgStatus(blob.size); }
      else updateBgStatus(0);
    } catch(e){ updateBgStatus(0); }
  })();

  document.getElementById("resetAssets").addEventListener("click",()=>{
    [LS.LOGO1,LS.LOGO2,LS.LOGO3,LS.BOOM,LS.HIT].forEach(k=>localStorage.removeItem(k));
    ["logoFile","logo2File","logo3File","boomFile","hitFile","bgFile"].forEach(id=>document.getElementById(id).value="");
    loadImg("logo1",DEFAULT_LOGO_URL); loadImg("logo2",""); loadImg("logo3",""); loadImg("boom",""); loadImg("hit",DEFAULT_HIT_ICON_URL);
    if(bgObjectUrl){ URL.revokeObjectURL(bgObjectUrl); bgObjectUrl=null; }
    idbDel(IDB_BG_KEY).catch(()=>{});
    setBg(null); updateBgStatus(0); drawPreviews();
  });

  // Previews
  const pCtx={ logo1:document.getElementById("logoPrev").getContext("2d"), logo2:document.getElementById("logo2Prev").getContext("2d"), logo3:document.getElementById("logo3Prev").getContext("2d"), boom:document.getElementById("boomPrev").getContext("2d"), hit:document.getElementById("hitPrev").getContext("2d"), bg:document.getElementById("bgPrev").getContext("2d") };

  function drawCirclePrev(pc,img,isRdy,label){ const w=pc.canvas.width,h=pc.canvas.height; pc.clearRect(0,0,w,h); pc.fillStyle="rgba(0,0,0,.25)"; pc.fillRect(0,0,w,h); const r=Math.min(w,h)*0.41,cx=w/2,cy=h/2; pc.save(); pc.beginPath(); pc.arc(cx,cy,r,0,Math.PI*2); pc.clip(); if(isRdy){ const s=Math.max(r*2/img.width,r*2/img.height); pc.drawImage(img,cx-img.width*s/2,cy-img.height*s/2,img.width*s,img.height*s); }else{ pc.fillStyle="rgba(255,255,255,.08)"; pc.fillRect(cx-r,cy-r,r*2,r*2); pc.fillStyle="#fff"; pc.font="bold 9px system-ui"; pc.textAlign="center"; pc.textBaseline="middle"; pc.fillText(label,cx,cy); } pc.restore(); pc.strokeStyle="rgba(255,255,255,.7)"; pc.lineWidth=2; pc.beginPath(); pc.arc(cx,cy,r,0,Math.PI*2); pc.stroke(); }

  function drawPreviews(){ ["logo1","logo2","logo3","boom","hit"].forEach(k=>drawCirclePrev(pCtx[k],imgs[k],rdy[k],k.toUpperCase())); const pc=pCtx.bg,w=pc.canvas.width,h=pc.canvas.height; pc.clearRect(0,0,w,h); pc.fillStyle="rgba(255,255,255,.08)"; pc.fillRect(0,0,w,h); pc.fillStyle="#fff"; pc.font="bold 9px system-ui"; pc.textAlign="center"; pc.textBaseline="middle"; pc.fillText("BG",w/2,h/2); pc.strokeStyle="rgba(255,255,255,.5)"; pc.lineWidth=2; pc.strokeRect(3,3,w-6,h-6); }
  setTimeout(drawPreviews,300);

  // Audio
  let audioCtx=null,drumGain=null,musicGain=null,drumBuffer=null;
  const bgMusicEl=new Audio(); bgMusicEl.loop=true;
  if(localStorage.getItem(LS.MUSIC)) bgMusicEl.src=localStorage.getItem(LS.MUSIC);
  let drumVol=0.80,musicVol=0.35;
  const drumVolLabel=document.getElementById("drumVolLabel"),musicVolLabel=document.getElementById("musicVolLabel");
  function pct(v){return Math.round(v*100)+"%";}
  drumVolLabel.textContent=pct(drumVol); musicVolLabel.textContent=pct(musicVol);
  document.getElementById("drumVol").addEventListener("input",e=>{ drumVol=Number(e.target.value); drumVolLabel.textContent=pct(drumVol); if(drumGain)drumGain.gain.value=drumVol; });
  document.getElementById("musicVol").addEventListener("input",e=>{ musicVol=Number(e.target.value); musicVolLabel.textContent=pct(musicVol); if(musicGain)musicGain.gain.value=musicVol; });
  function initAudio(){ if(audioCtx)return; audioCtx=new(window.AudioContext||window.webkitAudioContext)(); drumGain=audioCtx.createGain(); drumGain.gain.value=drumVol; drumGain.connect(audioCtx.destination); musicGain=audioCtx.createGain(); musicGain.gain.value=musicVol; musicGain.connect(audioCtx.destination); try{audioCtx.createMediaElementSource(bgMusicEl).connect(musicGain);}catch(e){} }
  async function unlockAudio(){ initAudio(); if(audioCtx.state==="suspended") await audioCtx.resume(); }
  const musicStatusEl   = document.getElementById("musicStatus");
  const drumSfxStatusEl = document.getElementById("drumSfxStatus");

  function showAudioStatus(){
    const mVal = localStorage.getItem(LS.MUSIC);
    const dVal = localStorage.getItem(LS.DRUM_SFX);
    musicStatusEl.textContent   = mVal ? "‚úÖ Saved (" + Math.round(mVal.length*0.75/1024) + " KB)" : "‚¨ú No file saved";
    musicStatusEl.style.color   = mVal ? "#7dffb3" : "rgba(255,255,255,0.45)";
    drumSfxStatusEl.textContent = dVal ? "‚úÖ Saved (" + Math.round(dVal.length*0.75/1024) + " KB)" : "‚¨ú No file saved";
    drumSfxStatusEl.style.color = dVal ? "#7dffb3" : "rgba(255,255,255,0.45)";
  }
  showAudioStatus();

  document.getElementById("musicFile").addEventListener("change", async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url = await readFile(f);
    try{
      localStorage.setItem(LS.MUSIC, url);
      bgMusicEl.src = url;
      if(running) bgMusicEl.play().catch(()=>{});
      showAudioStatus();
    } catch(err){
      musicStatusEl.textContent = "‚ùå File too large for storage (" + Math.round(f.size/1024) + "KB). Will play this session only.";
      musicStatusEl.style.color = "#ff6b6b";
      bgMusicEl.src = url; // still play it this session
    }
  });
  document.getElementById("resetMusic").addEventListener("click",()=>{
    localStorage.removeItem(LS.MUSIC);
    document.getElementById("musicFile").value="";
    bgMusicEl.pause(); bgMusicEl.src="";
    showAudioStatus();
  });
  async function loadDrumBuf(url){ await unlockAudio(); return new Promise(resolve=>{ try{ if(url.startsWith("data:")){ fetch(url).then(r=>r.arrayBuffer()).then(ab=>audioCtx.decodeAudioData(ab)).then(buf=>{drumBuffer=buf;resolve();}).catch(()=>{const xhr=new XMLHttpRequest();xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.onload=()=>audioCtx.decodeAudioData(xhr.response,buf=>{drumBuffer=buf;resolve();},()=>{drumBuffer=null;resolve();});xhr.onerror=()=>{drumBuffer=null;resolve();};xhr.send();}); }else{const xhr=new XMLHttpRequest();xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.onload=()=>audioCtx.decodeAudioData(xhr.response,buf=>{drumBuffer=buf;resolve();},()=>{drumBuffer=null;resolve();});xhr.onerror=()=>{drumBuffer=null;resolve();};xhr.send();} }catch(e){drumBuffer=null;resolve();} }); }
  if(localStorage.getItem(LS.DRUM_SFX)) loadDrumBuf(localStorage.getItem(LS.DRUM_SFX));

  document.getElementById("drumFile").addEventListener("change", async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url = await readFile(f);
    try{
      localStorage.setItem(LS.DRUM_SFX, url);
      await loadDrumBuf(url);
      showAudioStatus();
    } catch(err){
      drumSfxStatusEl.textContent = "‚ùå File too large for storage (" + Math.round(f.size/1024) + "KB). Will play this session only.";
      drumSfxStatusEl.style.color = "#ff6b6b";
      await loadDrumBuf(url);
    }
  });
  document.getElementById("resetDrum").addEventListener("click",()=>{
    localStorage.removeItem(LS.DRUM_SFX);
    document.getElementById("drumFile").value="";
    drumBuffer=null;
    showAudioStatus();
  });
  function playSynth(){ if(!audioCtx||audioCtx.state!=="running")return; const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type="sine"; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(90,t+0.12); g.gain.setValueAtTime(0.3,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.25); o.connect(g); g.connect(drumGain); o.start(t); o.stop(t+0.26); }
  async function playDrum(){ await unlockAudio(); if(!drumBuffer&&localStorage.getItem(LS.DRUM_SFX)) await loadDrumBuf(localStorage.getItem(LS.DRUM_SFX)); if(drumBuffer&&audioCtx.state==="running"){const s=audioCtx.createBufferSource();s.buffer=drumBuffer;s.connect(drumGain);s.start();}else playSynth(); }

  // ‚îÄ‚îÄ Gamepad / Drum controller ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const gpPrev = {};           // { gpIndex: { btnIndex: bool } }
  const btnTesterEl = document.getElementById("btnTester");
  let lastTesterUpdate = 0;

  function updateDrumStatus(){
    const gpList = navigator.getGamepads ? navigator.getGamepads() : [];
    const connected = [...gpList].filter(Boolean);
    if(connected.length === 0){
      drumStatusEl.textContent = "‚ö†Ô∏è No gamepad detected ‚Äî plug in drum & press a pad. Keyboard F/J also works.";
      drumStatusEl.style.color = "#ffd54a";
    } else {
      drumStatusEl.textContent = "‚úÖ " + connected.map(g=>`[${g.index}] ${g.id.substring(0,40)} (${g.buttons.length} btns)`).join(" | ");
      drumStatusEl.style.color = "#7dffb3";
    }
  }

  window.addEventListener("gamepadconnected", e => {
    console.log("Gamepad connected:", e.gamepad.id, "buttons:", e.gamepad.buttons.length, "axes:", e.gamepad.axes.length);
    updateDrumStatus();
  });
  window.addEventListener("gamepaddisconnected", e => {
    console.log("Gamepad disconnected:", e.gamepad.id);
    updateDrumStatus();
  });
  updateDrumStatus();

  function getMappedBtns(){
    return [
      parseInt(document.getElementById("btnDonL").value) || 0,
      parseInt(document.getElementById("btnDonR").value) || 1,
      parseInt(document.getElementById("btnKaL").value)  || 2,
      parseInt(document.getElementById("btnKaR").value)  || 3,
    ];
  }

  // ‚îÄ‚îÄ Input handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Single trigger called by ALL input methods
  function triggerHit(){
    if(!running) return;
    drumFlash = 0.18;
    hitTestAuto();
    playDrum().catch(()=>{});
  }

  // Gamepad polling ‚Äî ANY button or axis on ANY connected gamepad triggers hit
  function pollGamepads(){
    const gpList = navigator.getGamepads ? navigator.getGamepads() : [];
    for(const gp of gpList){
      if(!gp) continue;
      if(!gpPrev[gp.index]) gpPrev[gp.index] = {};

      // Every button
      for(let bi = 0; bi < gp.buttons.length; bi++){
        const isDown = gp.buttons[bi].pressed || gp.buttons[bi].value > 0.3;
        const wasDown = !!gpPrev[gp.index][bi];
        if(isDown && !wasDown){
          if(isEndScreen){
            endScreenHit(); // drum restarts game
          } else if(running){
            triggerHit();   // drum hits notes during game
          } else {
            // in menu ‚Äî show button tester
            try{ btnTesterEl.textContent = "ü•Å Button " + bi + " ‚Äî gamepad: " + gp.id.substring(0,40); btnTesterEl.style.color="#ffcf4a"; }catch(e){}
          }
        }
        gpPrev[gp.index][bi] = isDown;
      }

      // Every axis
      for(let ai = 0; ai < gp.axes.length; ai++){
        const val = gp.axes[ai];
        const key = "a" + ai;
        const isActive = Math.abs(val) > 0.7;
        const wasActive = !!gpPrev[gp.index][key];
        if(isActive && !wasActive){
          if(isEndScreen){
            endScreenHit();
          } else if(running){
            triggerHit();
          } else {
            try{ btnTesterEl.textContent = "ü•Å Axis " + ai + " = " + val.toFixed(2) + " ‚Äî gamepad: " + gp.id.substring(0,40); btnTesterEl.style.color="#ff9f2e"; }catch(e){}
          }
        }
        gpPrev[gp.index][key] = isActive;
      }
    }
  }

  setInterval(pollGamepads, 8);

  // Keyboard and canvas tap handled below in end screen section

  // Game constants
  const GAME_SECS=30,BASE_VX=420,HIT_ICON_SZ=330,HIT_RADIUS=185,HIT_WINDOW=180,LANE_GAP=140,MIN_NOTE_GAP=130,SPAWN_MARGIN=80;
  const items=[],pops=[];
  let hitX=Math.max(200,window.innerWidth*0.15); let hitY=window.innerHeight*0.62; let laneY1=hitY-70,laneY2=hitY+70;
  let running=false,score=0,timeLeft=0,last=0,nextBeatIn=0,bonusMode=false,drumFlash=0;
  const rand=(a,b)=>a+Math.random()*(b-a);

  function activeLogoTypes(){ const t=["logo1"]; if(rdy.logo2)t.push("logo2"); if(rdy.logo3)t.push("logo3"); return t; }
  function beatInterval(){ if(bonusMode)return 0.22; return Math.max(0.40,0.70/Math.sqrt(speedMul)); }

  function trySpawnInLane(laneY,type){ const size=rand(72,96),half=size*0.5,sw=window.innerWidth; let rm=-Infinity; for(const it of items){if(!it.alive)continue;if(Math.abs(it.y-laneY)<5&&it.x>rm)rm=it.x;} const idealX=sw+SPAWN_MARGIN+half,minX=rm===-Infinity?idealX:rm+half+size+MIN_NOTE_GAP; items.push({type,x:Math.max(idealX,minX),y:laneY,size,alive:true}); }

  function spawnGroup(){ const lt=activeLogoTypes(); const isBoom=Math.random()>(bonusMode?0.96:0.78); const type=isBoom?"boom":lt[Math.floor(Math.random()*lt.length)]; const isDbl=Math.random()<(bonusMode?0.55:0.26); if(isDbl){trySpawnInLane(laneY1,type);trySpawnInLane(laneY2,type);}else trySpawnInLane(Math.random()<0.5?laneY1:laneY2,type); }

  function canHit(it){ return Math.abs(it.x-hitX)<=HIT_WINDOW; }

  function resolveHit(it){
    it.alive=false;
    const delta=pts[it.type]||0;
    score+=delta;
    const sign=delta>=0?"+":"";
    pops.push({x:it.x,y:it.y,txt:`${sign}${delta}`,t:0.7,col:delta>=0?"#7dffb3":"#ff6b6b"});
    scoreEl.textContent=score;
  }

  function hitTestAuto(){
    // Only hit notes that are actually inside the hit window zone
    let best=null,bestD=Infinity;
    for(const it of items){
      if(!it.alive) continue;
      const d = Math.abs(it.x - hitX);
      if(d > HIT_WINDOW) continue; // must be within window ‚Äî no cheating!
      if(d < bestD){ bestD=d; best=it; }
    }
    if(best) resolveHit(best);
    else pops.push({x:hitX+60,y:hitY-60,txt:"MISS",t:0.45,col:"#ffd54a"});
  }

  function hitTestXY(px,py){ const dx0=px-hitX,dy0=py-hitY; if(dx0*dx0+dy0*dy0>HIT_RADIUS*HIT_RADIUS){hitTestAuto();return;} let best=null,bestS=Infinity; for(const it of items){if(!it.alive||!canHit(it))continue;const r=it.size*0.6,dx=px-it.x,dy=py-it.y;if(dx*dx+dy*dy<=r*r){const s=Math.abs(it.x-hitX)*2.4+Math.abs(it.y-py)*0.8;if(s<bestS){bestS=s;best=it;}}} if(best)resolveHit(best); else pops.push({x:hitX+220,y:hitY,txt:"MISS",t:0.45,col:"#ffd54a"}); }

  // Draw
  function drawCircleNote(img,size,isRdy,label){ const r=size*0.5; ctx.globalAlpha=0.20; ctx.fillStyle="#000"; ctx.beginPath(); ctx.ellipse(0,r*1.05,r*0.85,r*0.28,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; ctx.save(); ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.clip(); if(isRdy){const sc=Math.max(size/img.width,size/img.height);ctx.drawImage(img,-img.width*sc/2,-img.height*sc/2,img.width*sc,img.height*sc);}else{ctx.fillStyle="rgba(255,255,255,.10)";ctx.fillRect(-r,-r,r*2,r*2);ctx.fillStyle="#fff";ctx.font=`900 ${Math.floor(size*0.22)}px system-ui`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(label,0,0);} ctx.restore(); ctx.strokeStyle="rgba(255,255,255,.92)";ctx.lineWidth=5;ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();ctx.strokeStyle="rgba(255,213,74,.85)";ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,r-9,0,Math.PI*2);ctx.stroke(); }

  function drawHitDrum(){ if(drumFlash>0){ctx.globalAlpha=(drumFlash/0.18)*0.50;ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(hitX,hitY,HIT_RADIUS+70,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;} ctx.globalAlpha=0.14;ctx.fillStyle="#ffd54a";ctx.beginPath();ctx.arc(hitX,hitY,HIT_RADIUS+46,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;ctx.strokeStyle="rgba(255,213,74,.95)";ctx.lineWidth=10;ctx.beginPath();ctx.arc(hitX,hitY,HIT_RADIUS,0,Math.PI*2);ctx.stroke();ctx.save();ctx.translate(hitX,hitY);drawCircleNote(imgs.hit,HIT_ICON_SZ,rdy.hit,"DRUM");ctx.restore(); }

  function drawLanes(w){ ctx.globalAlpha=0.18;ctx.strokeStyle="#ffd54a";ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(0,laneY1);ctx.lineTo(w,laneY1);ctx.moveTo(0,laneY2);ctx.lineTo(w,laneY2);ctx.stroke();ctx.globalAlpha=1; }

  function star(x,y,R,r,p){ ctx.beginPath();let a=-Math.PI/2,st=Math.PI/p;ctx.moveTo(x+Math.cos(a)*R,y+Math.sin(a)*R);for(let i=0;i<p;i++){ctx.lineTo(x+Math.cos(a)*R,y+Math.sin(a)*R);a+=st;ctx.lineTo(x+Math.cos(a)*r,y+Math.sin(a)*r);a+=st;}ctx.closePath();ctx.fill(); }

  function drawNote(it){ ctx.save();ctx.translate(it.x,it.y); if(canHit(it)){ctx.strokeStyle="rgba(125,255,179,.95)";ctx.lineWidth=6;ctx.beginPath();ctx.arc(0,0,it.size*0.56+9,0,Math.PI*2);ctx.stroke();} if(it.type==="logo1")drawCircleNote(imgs.logo1,it.size,rdy.logo1,"L1"); else if(it.type==="logo2")drawCircleNote(imgs.logo2,it.size,rdy.logo2,"L2"); else if(it.type==="logo3")drawCircleNote(imgs.logo3,it.size,rdy.logo3,"L3"); else{ if(rdy.boom)drawCircleNote(imgs.boom,it.size,true,"BOOM"); else{ctx.fillStyle="#ff3b4a";star(0,0,it.size*0.62,it.size*0.32,10);ctx.fillStyle="#ffd54a";star(0,0,it.size*0.40,it.size*0.18,10);ctx.fillStyle="rgba(0,0,0,.55)";ctx.font=`900 ${Math.floor(it.size*0.25)}px system-ui`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("BOOM",0,0);} } ctx.restore(); }

  function loop(now){
    if(!running) return;
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;
    const w=window.innerWidth,h=window.innerHeight;
    hitX=Math.max(200,w*0.15); hitY=h*0.62; laneY1=hitY-LANE_GAP*0.5; laneY2=hitY+LANE_GAP*0.5;
    timeLeft-=dt; timeEl.textContent=Math.max(0,Math.ceil(timeLeft));
    if(!bonusMode&&timeLeft<=5){ bonusMode=true; pops.push({x:hitX+260,y:hitY-140,txt:"BONUS RUSH!",t:1.0,col:"#ffd54a"}); bgTint.style.background="rgba(255,213,74,0.07)"; }
    if(timeLeft<=0){endGame();return;}
    nextBeatIn-=dt; if(nextBeatIn<=0){spawnGroup();nextBeatIn=beatInterval();}
    for(const it of items){if(!it.alive)continue;it.x-=BASE_VX*speedMul*dt;if(it.x<-260)it.alive=false;}
    for(const p of pops){p.t-=dt;p.y-=30*dt;}
    if(drumFlash>0) drumFlash-=dt;
    ctx.clearRect(0,0,w,h);
    drawLanes(w); drawHitDrum();
    items.filter(i=>i.alive).sort((a,b)=>b.x-a.x).forEach(drawNote);
    for(const p of pops){ if(p.t<=0)continue; ctx.globalAlpha=Math.min(1,p.t/0.2); ctx.fillStyle=p.col; ctx.font="900 26px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(p.txt,p.x,p.y); ctx.globalAlpha=1; }
    requestAnimationFrame(loop);
  }

  function resetGame(){ items.length=0;pops.length=0;score=0;timeLeft=GAME_SECS;bonusMode=false;nextBeatIn=0;drumFlash=0;scoreEl.textContent=0;timeEl.textContent=GAME_SECS;savePts(); }

  function startGame(){ resetGame();hideMenu();running=true;last=performance.now();bgTint.style.background="rgba(10,0,8,0.35)";if(bgMusicEl.src){bgMusicEl.currentTime=0;bgMusicEl.play().catch(()=>{});}requestAnimationFrame(loop); }

  // ‚îÄ‚îÄ End screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let drumRestartCount = 0;
  const drumRestartNeeded = 3;
  let isEndScreen = false;
  let endScreenLoop = null;
  let endScreenStartTime = 0;
  const END_COOLDOWN = 3.0; // seconds before drum hits count toward restart

  function endGame(){
    running = false;
    isEndScreen = true;
    drumRestartCount = 0;
    endScreenStartTime = performance.now();
    bgMusicEl.pause();
    overlay.classList.add("hidden");
    canvas.classList.add("active");
    function endLoop(){
      if(!isEndScreen) return;
      drawEndScreen();
      endScreenLoop = requestAnimationFrame(endLoop);
    }
    endLoop();
  }

  function drawEndScreen(){
    const w = window.innerWidth, h = window.innerHeight;
    const elapsed = (performance.now() - endScreenStartTime) / 1000;
    const fadeIn = Math.min(1, elapsed / 0.6);          // fade in over 0.6s
    const coolingDown = elapsed < END_COOLDOWN;
    const cooldownLeft = Math.max(0, END_COOLDOWN - elapsed);

    ctx.clearRect(0,0,w,h);

    // Dark overlay ‚Äî fades in
    ctx.fillStyle = "rgba(0,0,0," + (0.78 * fadeIn) + ")";
    ctx.fillRect(0,0,w,h);

    if(fadeIn < 0.05) return; // nothing to draw yet

    // Rotate 90¬∞ clockwise for sideways TV
    ctx.save();
    ctx.translate(w, 0);
    ctx.rotate(Math.PI / 2);
    const rw = h, rh = w;

    ctx.globalAlpha = fadeIn;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // TIMEOUT ‚Äî bounces in
    const bounce = elapsed < 0.6 ? 1 + Math.sin(elapsed * Math.PI / 0.6) * 0.12 : 1;
    ctx.save();
    ctx.translate(rw/2, rh * 0.22);
    ctx.scale(bounce, bounce);
    ctx.fillStyle = "#ffd54a";
    ctx.font = "900 " + Math.floor(rw * 0.16) + "px system-ui";
    ctx.fillText("TIMEOUT!", 0, 0);
    ctx.restore();

    // Score
    ctx.globalAlpha = Math.min(1, Math.max(0, (elapsed - 0.3) / 0.4)) * fadeIn;
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 " + Math.floor(rw * 0.10) + "px system-ui";
    ctx.fillText("Score: " + score, rw/2, rh * 0.42);

    ctx.globalAlpha = Math.min(1, Math.max(0, (elapsed - 0.6) / 0.4)) * fadeIn;

    if(coolingDown){
      // Show countdown ring ‚Äî "get ready" phase
      const progress = 1 - (cooldownLeft / END_COOLDOWN);
      const ringR = Math.floor(rw * 0.07);
      const cx = rw/2, cy = rh * 0.67;

      // Background ring
      ctx.beginPath(); ctx.arc(cx, cy, ringR, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,0.15)"; ctx.lineWidth = 8; ctx.stroke();

      // Progress arc
      ctx.beginPath();
      ctx.arc(cx, cy, ringR, -Math.PI/2, -Math.PI/2 + progress * Math.PI*2);
      ctx.strokeStyle = "#ffd54a"; ctx.lineWidth = 8; ctx.stroke();

      // Countdown number
      ctx.fillStyle = "#ffd54a";
      ctx.font = "900 " + Math.floor(rw * 0.06) + "px system-ui";
      ctx.fillText(Math.ceil(cooldownLeft), cx, cy);

      ctx.fillStyle = "rgba(255,255,255,0.6)";
      ctx.font = "600 " + Math.floor(rw * 0.033) + "px system-ui";
      ctx.fillText("get ready‚Ä¶", rw/2, rh * 0.80);

    } else {
      // Cooldown done ‚Äî show drum restart prompt
      const hitsLeft = drumRestartNeeded - drumRestartCount;
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "700 " + Math.floor(rw * 0.042) + "px system-ui";
      ctx.fillText("Hit drum " + hitsLeft + " more time" + (hitsLeft!==1?"s":"") + " to restart", rw/2, rh * 0.60);

      // Progress dots
      const dotR = Math.floor(rw * 0.030);
      const gap   = dotR * 3.2;
      const totalDotW = (drumRestartNeeded - 1) * gap;
      for(let i = 0; i < drumRestartNeeded; i++){
        const dx = rw/2 - totalDotW/2 + i * gap;
        const dy = rh * 0.74;
        ctx.beginPath(); ctx.arc(dx, dy, dotR, 0, Math.PI*2);
        ctx.fillStyle = i < drumRestartCount ? "#ffd54a" : "rgba(255,255,255,0.2)";
        ctx.fill();
        ctx.strokeStyle = i < drumRestartCount ? "#ffd54a" : "rgba(255,255,255,0.45)";
        ctx.lineWidth = 3; ctx.stroke();
      }

      ctx.fillStyle = "rgba(255,255,255,0.35)";
      ctx.font = "500 " + Math.floor(rw * 0.027) + "px system-ui";
      ctx.fillText("or click START button", rw/2, rh * 0.88);
    }

    ctx.globalAlpha = 1;
    ctx.restore();
  }

  // Called by drum when end screen is showing
  function endScreenHit(){
    if(!isEndScreen) return;
    // Ignore hits during cooldown
    const elapsed = (performance.now() - endScreenStartTime) / 1000;
    if(elapsed < END_COOLDOWN) return;
    drumRestartCount++;
    playDrum().catch(()=>{});
    if(drumRestartCount >= drumRestartNeeded){
      isEndScreen = false;
      if(endScreenLoop) cancelAnimationFrame(endScreenLoop);
      startGame();
    }
  }

  // Keyboard ‚Äî only works during game, not end screen
  document.addEventListener("keydown", e=>{
    if(e.repeat) return;
    if(e.key==="f"||e.key==="F"||e.key==="j"||e.key==="J"||e.key===" "){
      if(!isEndScreen) triggerHit();
    }
  });

  // Canvas tap ‚Äî disabled on end screen (drum only restarts)
  canvas.addEventListener("pointerdown", e=>{
    if(isEndScreen) return; // ignore mouse/touch on end screen
    if(!running) return;
    drumFlash=0.18;
    const r=canvas.getBoundingClientRect();
    hitTestXY(e.clientX-r.left, e.clientY-r.top);
    playDrum().catch(()=>{});
  });

  // START button
  startBtn.addEventListener("click", async()=>{
    isEndScreen = false;
    if(endScreenLoop) cancelAnimationFrame(endScreenLoop);
    await unlockAudio();
    if(drumGain) drumGain.gain.value=drumVol;
    if(musicGain) musicGain.gain.value=musicVol;
    await goFullscreen(); resize(); startGame();
  });

})();
</script>
</body>
</html>
